## Codebase Patterns
- Migrations use Rails 8.1 format
- All tests run with `bin/rails test`
- Linting: `bin/rubocop`
- Settings dialog in AppSidebar uses RubyUI::Tabs for organizing settings sections
- New icons: create in app/components/icon/ inheriting from Base, use Lucide SVG paths
- Journal encryption content_iv format: "iv:auth_tag" (colon-separated base64) - extract with split(":")
- Routes with static paths (like /journals/unlock) must be defined BEFORE resources to avoid being matched as :id
- Test cache verification requires memory store swap (test env uses null_store)
- EncryptionService.decrypt uses keyword argument: `decrypt(ciphertext, iv, key, auth_tag: auth_tag)`
- Controller actions MUST be defined before `private` keyword or they won't be accessible

---

## 2026-01-12 - US-001
Thread: https://ampcode.com/threads/T-019bb370-9df3-7604-8b5a-568da4a141df
- Added migration to add journal encryption fields to users table
- Fields: journal_password_digest (string), journal_encryption_salt (string), encrypted_seed_phrase (text), journal_protection_enabled (boolean, default: false)
- Files changed:
  - db/migrate/20260112182122_add_journal_encryption_fields_to_users.rb (created)
  - db/schema.rb (updated automatically)
- **Learnings for future iterations:**
  - Rails generator interprets column names with "password" as password type, causing redaction issues - better to create migration files manually
  - All columns are nullable by default in Rails
---

## 2026-01-12 - US-002
Thread: https://ampcode.com/threads/T-019bb374-5737-714f-be4d-633f2c784a82
- Added migration to add encrypted content columns to journal_fragments table
- Columns: encrypted_content (text, nullable), content_iv (string, nullable)
- Original content column preserved for backward compatibility
- Files changed:
  - db/migrate/20260112182534_add_encrypted_content_to_journal_fragments.rb (created)
  - db/schema.rb (updated automatically)
- **Learnings for future iterations:**
  - Migration follows same pattern as US-001
---

## 2026-01-12 - US-003
Thread: https://ampcode.com/threads/T-019bb376-a4e1-7212-84f6-e192244c0b07
- Created Journals::EncryptionService with AES-256-GCM encryption
- Implemented encrypt, decrypt, derive_key, and generate_salt methods
- Uses PBKDF2 with 100,000 iterations for key derivation
- Files changed:
  - app/services/journals/encryption_service.rb (created)
  - test/services/journals/encryption_service_test.rb (created)
- **Learnings for future iterations:**
  - OpenSSL cipher returns ASCII-8BIT encoding, need to force_encoding("UTF-8") for text content
  - AES-256-GCM requires auth_tag for authenticated encryption (prevents tampering)
  - Service follows class method + instance method pattern (e.g., `self.encrypt` calls `new.encrypt`)
---

## 2026-01-12 - US-004
Thread: https://ampcode.com/threads/T-019bb379-5981-746f-a3ad-4e982021e0b4
- Created Journals::MnemonicService for BIP39 seed phrase generation and validation
- Added BIP39 English word list (2048 words) to lib/bip39_english.txt
- Implemented generate, validate, and derive_key methods
- Files changed:
  - lib/bip39_english.txt (created)
  - app/services/journals/mnemonic_service.rb (created)
  - test/services/journals/mnemonic_service_test.rb (created)
- **Learnings for future iterations:**
  - MnemonicService uses PBKDF2 with 2048 iterations (standard for BIP39), not 100k like EncryptionService
  - Phrase normalization is important: strip, downcase, rejoin with single spaces before deriving key
  - Service can be tested with EncryptionService to verify derived key works for encryption/decryption
---

## 2026-01-12 - US-005
Thread: https://ampcode.com/threads/T-019bb37c-a27b-745a-b4b0-5dc4ae907a47
- Added journal_protection_enabled? helper method to User model
- Method returns true only if journal_protection_enabled is true AND journal_password_digest is present
- Files changed:
  - app/models/user.rb (modified)
- **Learnings for future iterations:**
  - User model uses sections with comment headers for organizing methods (e.g., "# Role helper methods")
  - Following the existing pattern, added "# Journal protection helper" comment section
---

## 2026-01-12 - US-006
Thread: https://ampcode.com/threads/T-019bb37d-ddf9-759c-9f70-61aece331649
- Created Components::Icon::Lock component for padlock icon
- Follows existing Icon::Base pattern with render_icon_path method
- Uses standard Lucide-style padlock SVG paths
- Files changed:
  - app/components/icon/lock.rb (created)
- **Learnings for future iterations:**
  - Icon components use `s` parameter in render_icon_path for SVG element methods (s.path, s.rect, etc.)
  - Icon.for(:lock) works with underscore-to-camelcase conversion
---

## 2026-01-12 - US-007
Thread: https://ampcode.com/threads/T-019bb37e-f550-715d-a339-65f49c377725
- Created JournalProtectionController with show, create, update, destroy actions
- Added routes under settings: get/post/patch/delete /settings/journal_protection
- Created placeholder Views::JournalProtection::Show Phlex view
- Files changed:
  - app/controllers/journal_protection_controller.rb (created)
  - app/views/journal_protection/show.rb (created)
  - config/routes.rb (modified - added journal_protection routes nested under settings)
- **Learnings for future iterations:**
  - Routes nested under `resource :settings` generate paths like `/settings/journal_protection`
  - Named route becomes `journal_protection_settings_path`
  - Controller actions are stubs ready for implementation in later stories
---

## 2026-01-12 - US-008
Thread: https://ampcode.com/threads/T-019bb382-a071-70fd-8373-9387e60d0e25
- Created full Views::JournalProtection::Show view with protection status display
- Added buttons for Enable Protection, Change Password, and Disable Protection (placeholder actions)
- Created Icon::Key and Icon::LockOpen icon components
- Added Journal Protection tab to the Settings dialog in AppSidebar
- Files changed:
  - app/views/journal_protection/show.rb (modified - full implementation)
  - app/components/icon/key.rb (created)
  - app/components/icon/lock_open.rb (created)
  - app/components/app_sidebar.rb (modified - added journal protection tab)
- **Learnings for future iterations:**
  - Settings dialog uses RubyUI::Tabs for organizing sections
  - Button actions use Stimulus controllers with data attributes (e.g., `data-controller="enable-dialog"`)
  - New icons follow Icon::Base pattern with Lucide-style SVG paths
  - Link to full settings page from dialog tab using view_context helper paths
---

## 2026-01-13 - US-009
Thread: https://ampcode.com/threads/T-019bb5e1-3260-74f9-ac6f-29c8d1b1d9cc
- Created Views::JournalProtection::EnableDialog Phlex component with two-step flow
- Step 1: Password input form with confirmation field
- Step 2: Seed phrase display with warning and checkbox confirmation
- Created seed_phrase_confirm Stimulus controller to enable/disable submit button based on checkbox
- Created enable_dialog Stimulus controller to fetch and append dialog via turbo stream
- Updated JournalProtectionController show action to handle action_type param and render dialog
- Files changed:
  - app/views/journal_protection/enable_dialog.rb (created)
  - app/javascript/controllers/seed_phrase_confirm_controller.js (created)
  - app/javascript/controllers/enable_dialog_controller.js (created)
  - app/controllers/journal_protection_controller.rb (modified)
- **Learnings for future iterations:**
  - Dialog forms use modal-form Stimulus controller for loading toasts and dialog dismissal
  - Multi-step dialogs can use a hidden `step` field to track state
  - RubyUI::Checkbox can have additional data attributes merged for Stimulus targets/actions
  - enable_dialog controller pattern: fetch turbo_stream, parse with DOMParser, append template to body
---

## 2026-01-13 - US-010
Thread: https://ampcode.com/threads/T-019bb5e4-db18-72e0-8c60-44d5322968a9
- Implemented enable protection backend logic in JournalProtectionController#create
- Two-step flow: generate_seed (password validation, salt/seed generation) and confirm_seed (encrypt and save)
- Password stored with BCrypt hashing
- Seed phrase encrypted with AES-256-GCM using derived key
- Encrypted seed stored as "ciphertext:iv:auth_tag" format
- Added id="journal_protection_content" to Show view for turbo_stream updates
- Files changed:
  - app/controllers/journal_protection_controller.rb (modified - added create logic)
  - app/views/journal_protection/show.rb (modified - added wrapper id)
- **Learnings for future iterations:**
  - Toast pattern in this codebase: `turbo_stream.append("body", "<script>window.toast && window.toast('message', { type: 'success' });</script>")`
  - Session storage is appropriate for temporary password/salt during multi-step dialogs
  - Encrypted seed phrase format: ciphertext:iv:auth_tag (colon-separated, all base64)
---

## 2026-01-13 - US-011
Thread: https://ampcode.com/threads/T-019bb5e7-bda7-7469-b5c6-26c95484df3a
- Created Journals::BulkEncryptJob to encrypt all user's journal fragments
- Job iterates fragments using find_each, skips already encrypted or blank content
- Stores IV and auth_tag together as "iv:auth_tag" in content_iv column
- Added migration to make content column nullable (needed for encrypted fragments)
- Updated JournalFragment model: validates content presence only unless encrypted
- Added encrypted? helper method to JournalFragment
- Files changed:
  - app/jobs/journals/bulk_encrypt_job.rb (created)
  - db/migrate/20260113055246_change_content_nullable_on_journal_fragments.rb (created)
  - test/jobs/journals/bulk_encrypt_job_test.rb (created)
  - app/models/journal_fragment.rb (modified)
- **Learnings for future iterations:**
  - content_iv format is "iv:auth_tag" (colon-separated base64) - extract with split(":")
  - JournalFragment validation uses `unless: :encrypted?` for conditional content presence
  - When clearing content column, need migration to allow null values first
---

## 2026-01-13 - US-012
Thread: https://ampcode.com/threads/T-019bb5ed-03be-725c-8748-da1ff93264a8
- Added call to Journals::BulkEncryptJob.perform_later in handle_confirm_seed
- Job queued with user_id and derived encryption_key
- Updated toast message to inform user about background encryption
- Files changed:
  - app/controllers/journal_protection_controller.rb (modified)
- **Learnings for future iterations:**
  - Simple story: just needed to add one line to queue the job after user.update!
  - Toast message pattern: include context about background work ("Encrypting existing entries in the background...")
---

## 2026-01-13 - US-013
Thread: https://ampcode.com/threads/T-019bb5f7-3da5-76db-bbf8-c11100833ef2
- JournalUnlockController was already created in a previous iteration with US-014 components
- Fixed route order: moved /journals/unlock routes BEFORE resources :journals to prevent "unlock" being matched as :id
- Fixed test: cache verification test needed memory store since test env uses null_store
- Controller implements: new (render dialog), create (validate password, generate session token, store in cache)
- Session token stored in Rails.cache with 24-hour expiration
- Returns token via JavaScript for localStorage storage
- Files changed:
  - config/routes.rb (modified - reordered unlock routes before resources :journals)
  - test/controllers/journal_unlock_controller_test.rb (modified - cache test uses memory store)
- **Learnings for future iterations:**
  - Static routes like /journals/unlock must be defined BEFORE resourceful routes to avoid ID matching
  - Rails test env uses null_store by default - swap to MemoryStore for cache verification tests
---

## 2026-01-13 - US-014
Thread: https://ampcode.com/threads/T-019bb5fe-335f-7475-b727-d78976b58988
- Journal unlock dialog (Views::Journals::UnlockDialog) already existed from US-013 implementation
- Updated "Forgot password?" link to use ColoredLink with proper route to recovery flow
- Added recovery routes (get/post /journals/recover) for future US-022/US-023 implementation
- Created placeholder JournalRecoveryController with new/create actions
- Created placeholder Views::Journals::RecoveryForm view
- Files changed:
  - app/views/journals/_unlock_dialog.rb (modified - updated recovery link)
  - config/routes.rb (modified - added recovery routes)
  - app/controllers/journal_recovery_controller.rb (created - placeholder)
  - app/views/journals/recovery_form.rb (created - placeholder)
- **Learnings for future iterations:**
  - UnlockDialog was already implemented in US-013 - check existing files before creating new ones
  - Adding placeholder controllers/views for linked routes prevents broken links in dialog
  - Recovery routes follow same pattern as unlock routes (must be before resources :journals)
---

## 2026-01-13 - US-015
Thread: https://ampcode.com/threads/T-019bb601-392b-75ef-859b-b7a2b58aba90
- Created journal-unlock Stimulus controller for managing journal unlock state
- Controller stores session token in localStorage on successful unlock (token injected via server script)
- Adds X-Journal-Session header to all journal-related requests via turbo:before-fetch-request event
- Clears token on logout by detecting /users/sign_out requests
- Provides isLocked(), isUnlocked(), openUnlockDialog() helper methods
- Dispatches journal-unlock:stateChanged event for state changes
- Files changed:
  - app/javascript/controllers/journal_unlock_controller.js (created)
- **Learnings for future iterations:**
  - Stimulus controllers are auto-registered via eagerLoadControllersFrom
  - Use turbo:before-fetch-request event to add custom headers to Turbo requests
  - Server already handles token storage in localStorage via script injection in turbo_stream response
---

## 2026-01-13 - US-016
Thread: https://ampcode.com/threads/T-019bb603-3f6a-77af-b51c-8c9914c3dfa3
- Added before_action :check_journal_unlock to JournalsController show action
- Created Current model (ActiveSupport::CurrentAttributes) to store encryption_key in request context
- Created Views::Journals::Locked view for locked journal state
- check_journal_unlock validates X-Journal-Session header token against Rails cache
- If token invalid/missing: renders Locked view (HTML) or UnlockDialog (turbo_stream)
- If valid: decodes encryption_key from cache and stores in Current.encryption_key
- Files changed:
  - app/controllers/journals_controller.rb (modified)
  - app/models/current.rb (created)
  - app/views/journals/locked.rb (created)
- **Learnings for future iterations:**
  - ActiveSupport::CurrentAttributes (Current) is the Rails way to store request-scoped data
  - Cache key format: "journal_session:#{user_id}:#{token}" matches JournalUnlockController
  - Locked view uses journal-unlock Stimulus controller for openUnlockDialog action
---

## 2026-01-13 - US-017
Thread: https://ampcode.com/threads/T-019bb606-c241-705e-97cc-2477807a5149
- Added decrypted_content(key) method to JournalFragment model
- Returns plain content when not encrypted (backward compatible)
- Decrypts encrypted_content using EncryptionService when encrypted
- Raises ArgumentError if key is nil but content is encrypted
- Created comprehensive test suite for JournalFragment model
- Files changed:
  - app/models/journal_fragment.rb (modified)
  - test/models/journal_fragment_test.rb (created)
- **Learnings for future iterations:**
  - content_iv format "iv:auth_tag" is parsed with split(":") to extract both parts
  - decrypted_content(key) is the single point for getting fragment content (handles both encrypted and plain)
---

## 2026-01-13 - US-018
Thread: https://ampcode.com/threads/T-019bb608-6abd-73bb-ba1b-e9e12ac30fe3
- Added displayable_content method to JournalFragment model
- Method checks Current.encryption_key and automatically decrypts encrypted content
- Updated content_preview and rendered_markdown to use displayable_content
- Returns "[Encrypted content]" placeholder when encrypted but no key available
- No changes needed to views - they use existing methods that now auto-decrypt
- Files changed:
  - app/models/journal_fragment.rb (modified - added displayable_content method)
  - test/models/journal_fragment_test.rb (modified - added 5 new tests)
- **Learnings for future iterations:**
  - Using Current (ActiveSupport::CurrentAttributes) allows models to access request-scoped data
  - This pattern avoids having to pass encryption_key through the entire view hierarchy
  - JournalsController already sets Current.encryption_key in check_journal_unlock
---

## 2026-01-13 - US-019
Thread: https://ampcode.com/threads/T-019bb60b-f3e4-72da-90b7-67dc15f848c7
- Added before_save callback `encrypt_content_if_protected` to JournalFragment model
- Encrypts content on create/update when user has protection enabled and encryption key available
- Added `set_encryption_key` before_action to JournalFragmentsController to set Current.encryption_key from session token
- Callback checks: user.journal_protection_enabled?, Current.encryption_key present?, content present?
- Re-encrypts on update (removed "already encrypted" skip for handling content changes)
- Files changed:
  - app/models/journal_fragment.rb (modified - added before_save callback and private method)
  - app/controllers/journal_fragments_controller.rb (modified - added set_encryption_key and helper methods)
  - test/models/journal_fragment_test.rb (modified - added 4 new encryption tests)
- **Learnings for future iterations:**
  - JournalFragmentsController must also extract encryption key from X-Journal-Session header like JournalsController
  - before_save callback fires on both create and update - removed "return if encrypted?" to handle content updates
  - Current.encryption_key pattern used consistently across journal-related controllers and models
---

## 2026-01-13 - US-020
Thread: https://ampcode.com/threads/T-019bb60f-c6be-76af-9a3b-39710dce6247
- Updated Views::Journals::JournalCard to show lock icon when journal is locked
- Added render_journal_info private method to handle locked/unlocked display
- Added journal_locked? helper checking user.journal_protection_enabled? and Current.encryption_key.nil?
- When locked: shows prompts count + lock icon instead of entries count
- Journal dates always visible regardless of lock state
- Files changed:
  - app/views/journals/_journal_card.rb (modified)
- **Learnings for future iterations:**
  - JournalCard is rendered by ListContent, which is rendered by List - all share same view hierarchy
  - Current.encryption_key being nil indicates locked state when protection is enabled
---

## 2026-01-13 - US-021
Thread: https://ampcode.com/threads/T-019bb612-1cb8-75dc-9ea9-9260363a58ec
- Updated Views::Items::JournalLinkItem to show lock icon when journal is locked
- Added journal_locked? private helper method (same pattern as JournalCard)
- Updated render_badges to show lock icon when locked, fragment count when unlocked
- Lock icon displayed in teal badge matching existing styling
- Files changed:
  - app/views/items/_journal_link_item.rb (modified)
- **Learnings for future iterations:**
  - JournalLinkItem uses @record (Journal) and @day, access user via @record.user or @day&.user
  - Same journal_locked? pattern: user.journal_protection_enabled? && Current.encryption_key.nil?
---

## 2026-01-13 - US-022
Thread: https://ampcode.com/threads/T-019bb613-b1a9-701b-bd7c-311330011165
- Implemented JournalRecoveryController with full recovery flow
- new action renders RecoveryForm view (also updated view to be functional)
- create action validates seed phrase, new password, queues re-encryption
- Recovery uses MnemonicService.derive_key to derive old key from seed phrase
- New password derives new key using EncryptionService.derive_key
- Re-encrypts seed phrase with new key, updates password digest
- Queues BulkReencryptJob (placeholder - full implementation in US-024)
- Invalidates existing session tokens
- Routes already existed from US-014
- Files changed:
  - app/controllers/journal_recovery_controller.rb (modified - full implementation)
  - app/jobs/journals/bulk_reencrypt_job.rb (created - placeholder)
  - app/views/journals/recovery_form.rb (modified - made functional)
  - test/controllers/journal_recovery_controller_test.rb (created)
- **Learnings for future iterations:**
  - Recovery derives key from seed phrase (MnemonicService), not password (EncryptionService)
  - Session invalidation uses Rails.cache.delete_matched with pattern
  - Views don't use RubyUI::Card - use div with border/rounded classes instead
---

## 2026-01-13 - US-023
Thread: https://ampcode.com/threads/T-019bb61e-d5a1-74a4-b684-fa5a71c36e12
- Password recovery view (Views::Journals::RecoveryForm) already existed from US-022 work
- View meets all acceptance criteria: seed phrase textarea, password/confirmation fields, submit button, error display
- Redirect to journals on success handled in JournalRecoveryController
- All tests pass (30 runs, 75 assertions)
- Files changed:
  - tasks/prd.json (marked US-023 as complete)
- **Learnings for future iterations:**
  - When implementing controller + view together, check if both stories can be marked as complete
  - US-022 and US-023 were essentially the same implementation work
---

## 2026-01-13 - US-024
Thread: https://ampcode.com/threads/T-019bb621-1a66-751b-b084-6dc1f47cf617
- Implemented Journals::BulkReencryptJob with full re-encryption logic
- Job takes user_id, old_key, new_key and re-encrypts all encrypted fragments
- Uses decrypted_content(old_key) then EncryptionService.encrypt with new_key
- Includes graceful error handling for individual fragment failures (logs and continues)
- Created comprehensive test suite (5 tests)
- Files changed:
  - app/jobs/journals/bulk_reencrypt_job.rb (modified - replaced placeholder)
  - test/jobs/journals/bulk_reencrypt_job_test.rb (created)
- **Learnings for future iterations:**
  - EncryptionService wraps OpenSSL errors in DecryptionError - use that for assertions
  - Job pattern mirrors BulkEncryptJob but skips fragments without encrypted_content
---

## 2026-01-13 - US-025
Thread: https://ampcode.com/threads/T-019bb624-5cb0-719a-94ed-2def9881ff04
- Created Views::JournalProtection::ChangePasswordDialog Phlex component
- Dialog has current password, new password, and confirmation fields
- Uses modal-form Stimulus controller pattern for loading toast and dialog dismissal
- Updated JournalProtectionController show action to render dialog for change_password action_type
- Files changed:
  - app/views/journal_protection/change_password_dialog.rb (created)
  - app/controllers/journal_protection_controller.rb (modified)
- **Learnings for future iterations:**
  - ChangePasswordDialog follows same pattern as EnableDialog but simpler (no multi-step)
  - Form uses PATCH method for update action
---

## 2026-01-13 - US-026
Thread: https://ampcode.com/threads/T-019bb626-ceff-70e8-8982-a2dcc2ed7ac3
- Implemented JournalProtectionController#update action for changing journal password
- Full validation: current password (BCrypt), new password (length >= 8, confirmation match)
- Decrypts seed phrase with old key, re-encrypts with new key
- Updates journal_password_digest with new BCrypt hash
- Queues Journals::BulkReencryptJob with old and new keys for background re-encryption
- Invalidates session tokens via Rails.cache.delete_matched
- Clears localStorage token via JavaScript in turbo_stream response
- Created comprehensive test suite (10 tests) for update action
- Files changed:
  - app/controllers/journal_protection_controller.rb (modified - added update action)
  - test/controllers/journal_protection_controller_test.rb (created)
- **Learnings for future iterations:**
  - Methods MUST be placed BEFORE `private` keyword to be accessible as controller actions
  - EncryptionService.decrypt uses keyword argument `auth_tag:`, not positional argument
  - Encrypted seed format: ciphertext:iv:auth_tag - split with ":" and pass auth_tag as keyword arg
---

## 2026-01-13 - US-027
Thread: https://ampcode.com/threads/T-019bb62f-786f-738f-8108-39d4ec02c9c6
- Created Journals::BulkDecryptJob to decrypt all user's journal fragments
- Job takes user_id and encryption_key, iterates fragments using find_each
- Uses decrypted_content(key) method then clears encrypted_content and content_iv
- Includes error handling for individual fragment failures (logs and continues)
- Created comprehensive test suite (5 tests)
- Files changed:
  - app/jobs/journals/bulk_decrypt_job.rb (created)
  - test/jobs/journals/bulk_decrypt_job_test.rb (created)
- **Learnings for future iterations:**
  - BulkDecryptJob mirrors BulkEncryptJob but reverses the operation
  - Job pattern: iterate with find_each, skip non-applicable records, handle individual failures gracefully
---

## 2026-01-13 - US-028
Thread: https://ampcode.com/threads/T-019bb633-234f-72dc-9d0a-b65533ed41d3
- Created Views::JournalProtection::DisableDialog Phlex component
- Uses RubyUI::AlertDialog with password confirmation field
- Includes warning text about decryption consequences
- Submit button triggers DELETE to destroy action
- Updated controller show action to render dialog for "disable" action_type
- Added test for disable dialog rendering
- Files changed:
  - app/views/journal_protection/disable_dialog.rb (created)
  - app/controllers/journal_protection_controller.rb (modified)
  - test/controllers/journal_protection_controller_test.rb (modified)
- **Learnings for future iterations:**
  - AlertDialog with form needs id wrapper div for turbo_stream targeting (e.g., id="disable_protection_dialog")
  - Form inside AlertDialog should have `data: { action: "submit@document->ruby-ui--alert-dialog#dismiss" }`
---

## 2026-01-13 - US-029
Thread: https://ampcode.com/threads/T-019bb637-0ec5-75d0-b64a-691824686d27
- Implemented JournalProtectionController#destroy action to disable journal protection
- Validates current password against journal_password_digest using BCrypt
- Derives encryption key from password for BulkDecryptJob
- Queues BulkDecryptJob to decrypt all fragments in background
- Clears all protection fields: journal_password_digest, encrypted_seed_phrase, journal_encryption_salt
- Sets journal_protection_enabled to false
- Invalidates session tokens via Rails.cache.delete_matched
- Clears localStorage token via JavaScript in turbo_stream response
- Shows success toast indicating decryption in progress
- Fixed DisableDialog to use "current_password" param name (was "password")
- Added render_disable_dialog_with_errors helper for error handling
- Created 6 comprehensive tests for destroy action
- Files changed:
  - app/controllers/journal_protection_controller.rb (modified - added destroy action implementation)
  - app/views/journal_protection/disable_dialog.rb (modified - fixed param name)
  - test/controllers/journal_protection_controller_test.rb (modified - added 6 destroy tests)
- **Learnings for future iterations:**
  - destroy action follows same pattern as update: validate password, derive key, queue job, clear data
  - Param names in dialog must match controller expectations (current_password vs password)
---

## 2026-01-13 - US-030
Thread: https://ampcode.com/threads/T-019bb640-699a-7195-9201-d663584ceda4
- Created Components::Settings::JournalProtectionTab component with inline forms
- Tab shows current protection status with badge (Protected/Not Protected)
- When protected: shows buttons for Change Password, Recover via Seed Phrase, Disable Protection
- When unprotected: shows Enable Protection button and two-step enable flow with seed phrase display
- Each form is rendered inline when action button is clicked
- Updated JournalProtectionController to handle `from_tab` param for tab-specific responses
- Updated JournalRecoveryController to handle `from_tab` param for recovery in settings modal
- Renamed error helper methods: render_enable_dialog_with_errors â†’ render_enable_form_with_errors, etc.
- Updated AppSidebar to use new JournalProtectionTab component in settings dialog
- Files changed:
  - app/components/settings/journal_protection_tab.rb (created)
  - app/controllers/journal_protection_controller.rb (modified - from_tab support, renamed error methods)
  - app/controllers/journal_recovery_controller.rb (modified - from_tab support)
  - app/components/app_sidebar.rb (modified - uses JournalProtectionTab component)
- **Learnings for future iterations:**
  - Tab forms use `tab_form` param to specify which form to show when navigating to show action
  - `from_tab` param determines whether to update the tab component or dialog-based views
  - Cancel buttons re-navigate to the show action without active_form to return to button state
---
